ÿ®ÿ≥ŸÖ ÿßŸÑŸÑŸá ÿßŸÑÿ±ÿ≠ŸÖŸÜ ÿßŸÑÿ±ÿ≠ŸäŸÖ

# üì¶ E-commerce Data Pipeline (Airflow + DuckDB + Postgres)

![Architecture Diagram](images/Ecommerce_Data.png)


## üéØ –ó–∞–¥–∞—á–∞ –ø—Ä–æ–µ–∫—Ç–∞
–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –Ω–∞–¥—ë–∂–Ω—ã–π end-to-end data pipeline –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏, –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ e-commerce –¥–∞–Ω–Ω—ã—Ö.

### –ü—Ä–æ–µ–∫—Ç —Ä–µ—à–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–¥–∞—á–∏:
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ API
- –•—Ä–∞–Ω–µ–Ω–∏–µ —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–æ—Ä–º–∞—Ç–µ Data Lake (S3)
- –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Å–ª–æ—è –¥–∞–Ω–Ω—ã—Ö (ODS)
- –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –≤–∏—Ç—Ä–∏–Ω (Data Mart)
- –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –º–µ–∂–¥—É —ç—Ç–∞–ø–∞–º–∏

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞:
- –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
- –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç—å —Ä–∞—Å—á—ë—Ç–æ–≤
- –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é

## üèó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

```
External API (E-commerce)
        ‚Üì
RAW layer (S3 / MinIO, Parquet)
        ‚Üì
ODS layer (PostgreSQL)
        ‚Üì
Data Mart (PostgreSQL)
```

## –°–ª–æ–∏ –¥–∞–Ω–Ω—ã—Ö

### RAW
–°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ, –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ API, —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ S3 (MinIO) –≤ —Ñ–æ—Ä–º–∞—Ç–µ Parquet –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.

### ODS (Operational Data Store)
–î–∞–Ω–Ω—ã–µ –ø—Ä–∏–≤–æ–¥—è—Ç—Å—è –∫ —Ç–∞–±–ª–∏—á–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ PostgreSQL. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è upsert-–ª–æ–≥–∏–∫–∞ –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏.

### Data Mart (DM)
–ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –≤–∏—Ç—Ä–∏–Ω—ã, –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –¥–ª—è BI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.

## üß© –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
- **Apache Airflow** ‚Äî –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è –ø–∞–π–ø–ª–∞–π–Ω–æ–≤ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏
- **DuckDB** ‚Äî –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π ETL-–¥–≤–∏–∂–æ–∫
- **PostgreSQL** ‚Äî ODS –∏ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
- **MinIO (S3 compatible storage)** ‚Äî Data Lake
- **Docker / Docker Compose** ‚Äî –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è –∏ –ª–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫

## üîÅ –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è (DAG'–∏)

### `raw_s3_api`
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ e-commerce API
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç snapshot –¥–∞–Ω–Ω—ã—Ö –≤ S3 (Parquet)
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø–æ–≤—Ç–æ—Ä—è–µ–º–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–æ–∫

### `ecommerce_ods_pg`
- –û–∂–∏–¥–∞–µ—Ç —É—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ RAW —Å–ª–æ—è
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ S3 –≤ PostgreSQL (ODS)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `INSERT ... ON CONFLICT DO UPDATE`

### `dm_ecommerce_analytics`
- –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ODS
- –§–æ—Ä–º–∏—Ä—É–µ—Ç –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫—É—é –≤–∏—Ç—Ä–∏–Ω—É –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º —Ç–æ–≤–∞—Ä–æ–≤
- –†–∞—Å—á—ë—Ç—ã –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –ª–æ–≥–∏—á–µ—Å–∫–æ–π –¥–∞—Ç–µ Airflow (`ds`)

## üìä –ü—Ä–∏–º–µ—Ä –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–π –≤–∏—Ç—Ä–∏–Ω—ã

**–¢–∞–±–ª–∏—Ü–∞:** `dm.fct_ecommerce`

| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|----------|
| `report_date` | DATE | –î–∞—Ç–∞ –æ—Ç—á—ë—Ç–∞ |
| `category` | TEXT | –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ç–æ–≤–∞—Ä–∞ |
| `product_count` | INTEGER | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ |
| `total_stock` | INTEGER | –û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —Å–∫–ª–∞–¥–µ |
| `avg_price` | NUMERIC | –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ |
| `avg_rating` | NUMERIC | –°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥ |

**–í–∏—Ç—Ä–∏–Ω–∞ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è:**
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–∞
- –ê–Ω–∞–ª–∏–∑–∞ —Ü–µ–Ω –∏ –æ—Å—Ç–∞—Ç–∫–æ–≤
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å BI-—Å–∏—Å—Ç–µ–º–∞–º–∏

## ‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞

### –ó–∞–ø—É—Å–∫ –≤—Å–µ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã:
```bash
docker-compose up -d
```

### –î–∞–ª–µ–µ:
1. –ü–µ—Ä–µ–π—Ç–∏ –≤ **Airflow UI** (http://localhost:8080)
2. –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å DAG'–∏
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞–π–ø–ª–∞–π–Ω—ã –≤ –ø–æ—Ä—è–¥–∫–µ:
   - `raw_s3_api`
   - `ecommerce_ods_pg`
   - `dm_ecommerce_analytics`

## ‚öôÔ∏è –ö–ª—é—á–µ–≤—ã–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã
1. **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Å–ª–æ—è–º** (RAW / ODS / DM)
2. **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –≤—Å–µ—Ö –ø–∞–π–ø–ª–∞–π–Ω–æ–≤**
3. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏—á–µ—Å–∫–æ–π –¥–∞—Ç—ã Airflow –≤–º–µ—Å—Ç–æ `CURRENT_DATE`**
4. **–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ RAW, –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ ‚Äî –≤ DM**
5. **–ß—ë—Ç–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –º–µ–∂–¥—É —Å–ª–æ—è–º–∏ —á–µ—Ä–µ–∑ `ExternalTaskSensor`**

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ MinIO
1. –û—Ç–∫—Ä–æ–π—Ç–µ MinIO UI: http://localhost:9000
2. –°–æ–∑–¥–∞–π—Ç–µ bucket:
   - –ù–∞–∂–º–∏—Ç–µ **Create Bucket**
   - –í–≤–µ–¥–∏—Ç–µ –∏–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: `supfun`)
   - –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Å–æ–∑–¥–∞–Ω–∏–µ
3. –°–æ–∑–¥–∞–π—Ç–µ Access Keys:
   - –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Access Keys** ‚Üí **Create access key**
   - –°–∫–æ–ø–∏—Ä—É–π—Ç–µ `Access Key` –∏ `Secret Key`
   - –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –º–µ—Å—Ç–æ

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Airflow Variables
–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ Airflow UI: http://localhost:8080

**Admin ‚Üí Variables ‚Üí +**:

| Key | Value | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----|-------|----------|
| `access_key` | `–≤–∞—à_access_key` | MinIO Access Key |
| `secret_key` | `–≤–∞—à_secret_key` | MinIO Secret Key |
| `pg_password` | `postgres` | –ü–∞—Ä–æ–ª—å PostgreSQL |

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Airflow Connections
**Admin ‚Üí Connections ‚Üí +**:

**PostgreSQL Connection:**
- **Connection ID**: `postgres_dwh`
- **Connection Type**: `Postgres`
- **Host**: `postgres_dwh`
- **Database**: `postgres`
- **Login**: `postgres`
- **Password**: `postgres`
- **Port**: `5432`
- **Schema**: `postgres`

–ù–∞–∂–º–∏—Ç–µ **Save**.

### 4. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: `.env` —Ñ–∞–π–ª (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:
```bash
# MinIO
MINIO_ACCESS_KEY=–≤–∞—à_access_key
MINIO_SECRET_KEY=–≤–∞—à_secret_key

# PostgreSQL
POSTGRES_PASSWORD=postgres

# Airflow
AIRFLOW_UID=1000
```

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
```
ecommerce-pipeline/
‚îú‚îÄ‚îÄ dags/                          # Airflow DAG'–∏
‚îÇ   ‚îú‚îÄ‚îÄ raw_s3_api.py             # RAW ‚Üí S3
‚îÇ   ‚îú‚îÄ‚îÄ ecommerce_ods_pg.py       # S3 ‚Üí ODS
‚îÇ   ‚îî‚îÄ‚îÄ dm_ecommerce_analytics.py # ODS ‚Üí DM
‚îú‚îÄ‚îÄ docker-compose.yml            # Docker Compose –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ .env                          # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–Ω–µ –≤ Git)
‚îú‚îÄ‚îÄ .gitignore                    # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º—ã–µ —Ñ–∞–π–ª—ã
‚îú‚îÄ‚îÄ README.md                     # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îî‚îÄ‚îÄ requirements.txt              # Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
```

## üìä –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MetaBase
–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞:
1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:3000
2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL:
   - **Host**: `postgres_dwh`
   - **Port**: `5432`
   - **Database**: `postgres`
   - **Username**: `postgres`
   - **Password**: `postgres`
3. –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:
   - `ods.fct_products` ‚Äî —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä–æ–≤
   - `dm.simple_products` ‚Äî –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–∏—Ç—Ä–∏–Ω–∞

## üêõ –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º
### 1. "Connection failed" –≤ Airflow
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –∑–∞–ø—É—â–µ–Ω –ª–∏ PostgreSQL
docker ps | grep postgres

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
docker logs earthquake-postgres_dwh-1
```

### 2. MinIO –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—Ä—Ç—ã
netstat -an | grep 9000

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ MinIO
docker-compose restart minio
```

### 3. DAG –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Variables –≤ Airflow UI
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ Connections —Å–æ–∑–¥–∞–Ω—ã
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Airflow Scheduler